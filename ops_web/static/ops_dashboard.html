<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEXT-TRADE OPS Dashboard (OVL-001)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .grid { display: grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap: 10px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .k { font-size: 12px; color: #666; }
    .v { font-size: 20px; font-weight: 700; margin-top: 4px; }
    .row { display: flex; gap: 10px; margin-top: 12px; }
    .panel { flex: 1; border: 1px solid #ddd; border-radius: 10px; padding: 10px; min-height: 380px; }
    .hdr { display: flex; align-items: baseline; justify-content: space-between; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    #events { white-space: pre-wrap; line-height: 1.35; }
    .pill { padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
  </style>
</head>
<body>
  <h2 style="margin:0">OPS Dashboard <span class="pill">OVL-001</span></h2>
  <div class="k">Real-time: SSE <span class="mono">/events</span> · Metrics: <span class="mono">/api/ops/metrics</span></div>

  <div class="grid" style="margin-top:12px">
    <div class="card"><div class="k">HEALTH</div><div id="health" class="v">—</div></div>
    <div class="card"><div class="k">KILL-SWITCH</div><div id="killsw" class="v">—</div></div>
    <div class="card"><div class="k">RISK</div><div id="risk" class="v">—</div></div>
    <div class="card"><div class="k">DROP COUNT</div><div id="drop" class="v">—</div></div>
    <div class="card"><div class="k">SUBSCRIBERS</div><div id="subs" class="v">—</div></div>
    <div class="card"><div class="k">BUS QMAX</div><div id="qmax" class="v">—</div></div>
  </div>

  <div class="row">
    <div class="panel">
      <div class="hdr">
        <div><b>Event Timeline</b> <span class="k">(SSE)</span></div>
        <div class="k">status: <span id="sseStatus" class="mono">connecting…</span></div>
      </div>
      <div id="events" class="mono" style="margin-top:10px"></div>
    </div>
    <div class="panel">
      <div class="hdr">
        <div><b>Metrics Snapshot</b></div>
        <div class="k">last: <span id="lastTs" class="mono">—</span></div>
      </div>
      <div id="metrics" class="mono" style="margin-top:10px"></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const BASE = location.origin;

function setCard(id, val) { $(id).textContent = (val === undefined || val === null) ? "—" : String(val); }
function nowIso() { return new Date().toISOString(); }

// OVL-002 data structures
const MAX_BUFFER = 500;
const eventsBuffer = [];
const groupsByTrace = new Map();
const observedTypes = new Set();

// UI controls (insert controls row)
const controls = document.createElement('div');
controls.style.marginTop = '10px';
controls.innerHTML = `
  <label class="k">Type:</label>
  <select id="typeFilter" style="margin-right:10px"><option value="">(all)</option></select>
  <label class="k">Trace:</label>
  <input id="traceSearch" placeholder="trace_id or substring" style="margin-right:10px" />
  <button id="exportBtn">Export JSON</button>
`;
document.querySelector('body > .row').parentNode.insertBefore(controls, document.querySelector('.row'));

const typeFilter = () => $("typeFilter").value;
const traceQuery = () => $("traceSearch").value.trim().toLowerCase();

function updateTypeOptions() {
  const sel = $("typeFilter");
  const existing = new Set(Array.from(sel.options).map(o => o.value));
  observedTypes.forEach(t => {
    if (!existing.has(t)) {
      const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o);
    }
  });
}

function handleEvent(raw) {
  let obj;
  try { obj = JSON.parse(raw); } catch (e) { obj = { raw }; }
  const evt = {
    ts: obj.ts || nowIso(),
    trace_id: obj.trace_id || obj.traceId || (obj.trace || 'unknown'),
    type: obj.type || obj.event_type || 'event',
    source: obj.source || obj.src || '',
    payload: obj,
  };

  // buffer
  eventsBuffer.push(evt);
  if (eventsBuffer.length > MAX_BUFFER) eventsBuffer.shift();

  // groups
  const tid = String(evt.trace_id || '');
  let g = groupsByTrace.get(tid);
  if (!g) {
    g = { trace_id: tid, first_ts: evt.ts, last_ts: evt.ts, count: 0, types: new Set(), events: [] };
    groupsByTrace.set(tid, g);
  }
  g.events.push(evt);
  if (g.events.length > 200) g.events.shift();
  g.count = g.events.length;
  g.last_ts = evt.ts;
  if (!g.first_ts) g.first_ts = evt.ts;
  g.types.add(evt.type);

  observedTypes.add(evt.type);
  updateTypeOptions();

  renderGroups();
  renderRawTail();
}

function renderGroups() {
  const eventsDiv = $("events");
  const selectedType = typeFilter();
  const q = traceQuery();

  const groups = Array.from(groupsByTrace.values())
    .filter(g => {
      if (selectedType && !g.types.has(selectedType)) return false;
      if (q && !g.trace_id.toLowerCase().includes(q)) return false;
      return true;
    })
    .sort((a,b) => (b.last_ts || '') > (a.last_ts || '') ? 1 : -1);

  let html = '';
  groups.forEach(g => {
    const repType = Array.from(g.types)[0] || '-';
    const shortTid = g.trace_id ? g.trace_id.slice(0,8) : '(none)';
    html += `<div class="card" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><b>${shortTid}</b> <span class="k">${g.trace_id}</span></div>
        <div class="k">${g.first_ts} → ${g.last_ts} · ${g.count} events · ${repType}</div>
      </div>
      <div style="margin-top:8px; font-size:12px; max-height:200px; overflow:auto; background:#fafafa; padding:6px;">${g.events.map(e=>`<div style="border-bottom:1px solid #eee;padding:4px 0"><span class="k">${e.ts}</span> <b>${e.type}</b> ${e.payload.message ? '- ' + (e.payload.message) : ''}</div>`).join('')}</div>
    </div>`;
  });

  if (!html) html = '<div class="k">(no groups)</div>';
  eventsDiv.innerHTML = html;
}

function renderRawTail() {
  const out = $("metrics");
  // show last 50 raw events for debug
  const raw = eventsBuffer.slice(-50).map(e => ({ ts: e.ts, trace_id: e.trace_id, type: e.type, source: e.source }));
  // do not overwrite metrics panel JSON, but show raw below it
  const rawElId = 'rawTail';
  let rawEl = document.getElementById(rawElId);
  if (!rawEl) {
    rawEl = document.createElement('pre'); rawEl.id = rawElId; rawEl.style.marginTop = '10px'; rawEl.className = 'mono';
    out.parentNode.appendChild(rawEl);
  }
  rawEl.textContent = JSON.stringify(raw, null, 2);
}

// export current filtered eventsBuffer
function exportJSON() {
  const selectedType = typeFilter();
  const q = traceQuery();
  const filtered = eventsBuffer.filter(e => {
    if (selectedType && e.type !== selectedType) return false;
    if (q && !(String(e.trace_id || '').toLowerCase().includes(q))) return false;
    return true;
  });
  const payload = { exported_at: nowIso(), count: filtered.length, events: filtered };
  const name = `ops_events_${new Date().toISOString().replace(/[:.]/g,'')}.json`;
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// wire controls
document.addEventListener('DOMContentLoaded', () => {
  const typeSel = $("typeFilter");
  const trIn = $("traceSearch");
  const exBtn = $("exportBtn");
  typeSel.addEventListener('change', renderGroups);
  trIn.addEventListener('input', renderGroups);
  exBtn.addEventListener('click', exportJSON);
});

async function pollMetrics() {
  try {
    const r = await fetch(`${BASE}/api/ops/metrics`, { cache: "no-store" });
    const j = await r.json();

    setCard("drop", j.drop_count ?? j.dropCount ?? "—");
    setCard("subs", j.subscribers ?? j.subs ?? "—");
    setCard("qmax", j.queue_maxsize ?? j.qmax ?? j.bus_qmax ?? (j.config?.queue_maxsize ?? "—"));

    setCard("health", j.health ?? "OK");
    setCard("risk", j.risk_level ?? j.risk ?? "NORMAL");
    setCard("killsw", j.kill_switch ?? j.killswitch ?? "OFF");

    $("metrics").textContent = JSON.stringify(j, null, 2);
    $("lastTs").textContent = nowIso();
  } catch (e) {
    $("metrics").textContent = `METRICS_ERROR: ${e.message}`;
  }
}

function startSSE() {
  const es = new EventSource(`${BASE}/events`);
  $("sseStatus").textContent = "connecting…";
  es.onopen = () => { $("sseStatus").textContent = "connected"; };
  es.onmessage = (ev) => { handleEvent(ev.data); };
  es.onerror = () => { $("sseStatus").textContent = "error/reconnecting…"; };
}

pollMetrics();
setInterval(pollMetrics, 1500);
startSSE();
</script>
</body>
</html>
